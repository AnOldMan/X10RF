<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>X10 RF PARSING</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type="text/css">
        html, body {
            background: lightgray;
            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
        }
        .modal-on body {
            overflow: hidden;
            position: static;
        }
        .modal-context {
            background-color: rgba(22, 23, 23, 0.5);
            height: 100%;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 700;
            -webkit-overflow-scrolling: auto;
        }
        .modal-container {
            background: #ffffff;
            border-radius: 6px;
            box-shadow: 0 0 4px rgba(22, 23, 23, 0.3);
            box-sizing: border-box;
            display: block;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: calc(100% - 2em);
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: absolute;
            width: 300px;
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            bottom: auto;
            left: auto;
            background: none;
            border: 0;
            cursor: pointer;
            font-size: 0;
            height: 17px;
            line-height: 0;
            padding: 0;
            width: 16px;
            z-index: 10;
        }
        .modal-content {
            text-align: center;
        }
        @media all and (max-width: 767px) {
            .modal-on {
                overflow: hidden;
            }
            .modal-on body {
                position: fixed;
                width: 100%;
            }
            .modal-close {
                top: 10px;
            }
            .modal-container {
                margin: 20px auto;
                min-width: 280px;
                max-width: calc(100% - 40px);
                padding: 0;
                width: auto;
            }
            .modal-content {
                margin-left: 20px;
                margin-right: 20px;
                padding-bottom: 20px;
            }
        }
    </style>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
    <table style="margin: 1em auto; min-height: 500px; width: 90%;">
        <tbody>
            <tr>
                <td>
                    <label for="raw-data">Raw Data (scan)</label>
                    <textarea style="min-height: 250px; width: 100%;" id="raw-data"></textarea>
                </td>
            </tr>
            <tr>
                <td>
                    <button id="parse">Parse</button>
                </td>
            </tr>
            <tr>
                <td>
                    &nbsp;
                </td>
            </tr>
            <tr>
                <td>
                    <select id="housecode">
                        <option value="">-</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="G">G</option>
                        <option value="H">H</option>
                        <option value="I">I</option>
                        <option value="J">J</option>
                        <option value="K">K</option>
                        <option value="L">L</option>
                        <option value="M">M</option>
                        <option value="N">N</option>
                        <option value="O">O</option>
                        <option value="P">P</option>
                    </select>
                    <select id="unitcode">
                        <option value="">-</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                    </select>
                    <select id="action">
                        <option value="false">OFF</option>
                        <option value="true">ON</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>
                    <button id="generate">Generate</button>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="raw-data">Generated Data</label>
                    <textarea style="min-height: 250px; width: 100%;" id="generated-data"></textarea>
                </td>
            </tr>
        </tbody>
    </table>
    <script type="text/javascript">
        const housecodes = [
            { code: 'A', bit: '0110' },
            { code: 'B', bit: '1110' },
            { code: 'C', bit: '0010' },
            { code: 'D', bit: '1010' },
            { code: 'E', bit: '0001' },
            { code: 'F', bit: '1001' },
            { code: 'G', bit: '0101' },
            { code: 'H', bit: '1101' },
            { code: 'I', bit: '0111' },
            { code: 'J', bit: '1111' },
            { code: 'K', bit: '0011' },
            { code: 'L', bit: '1011' },
            { code: 'M', bit: '0000' },
            { code: 'N', bit: '1000' },
            { code: 'O', bit: '0100' },
            { code: 'P', bit: '1100' }
        ];
        const unitcodes = [
            { code: '1', bit: '0000' },
            { code: '2', bit: '0010' },
            { code: '3', bit: '0100' },
            { code: '4', bit: '0110' },
            { code: '5', bit: '0001' },
            { code: '6', bit: '0011' },
            { code: '7', bit: '0101' },
            { code: '8', bit: '0111' },
            { code: '9', bit: '1000' },
            { code: '10', bit: '1010' },
            { code: '11', bit: '1100' },
            { code: '12', bit: '1110' },
            { code: '13', bit: '1001' },
            { code: '14', bit: '1011' },
            { code: '15', bit: '1101' },
            { code: '16', bit: '1111' }
        ];
        const sendOne = 'FFFFFF0000000000000000';
        const sendZero = 'FFFFFF00000';
        function openModal(msg) {
            var $modal = $($('#modal').html());
            $('.modal-content', $modal).html(msg);
            $('.modal-close', $modal).on('click', function () {
                $modal.remove();
                $('body').removeClass('modal-on');
                delete $modal;
            });
            $('body').addClass('modal-on').append($modal);
        }
        function getbit(v) {
            // short is zero, long is one
            return v.length > 14 ? '1' : '0';
        }
        function checksum(a, b) {
            b = b.replace(/1/g, 'x').replace(/0/g, 'y').replace(/x/g, '0').replace(/y/g, '1');
            return a === b;
        }
        function reverseBits(bits) {
            return bits.split('').reverse().join('');
        }
        function houseFromCode(byte) {
            var p = byte.substring(4),
                r = $.grep(housecodes, function (g) { return g.bit === p; });
            return r.length ? r[0].code : '-';
        }
        function unitFromCode(bytes) {
            var c = bytes[0].substring(2, 3) + bytes[1].substring(3, 4) + bytes[1].substring(4, 5) + bytes[1].substring(6, 7),
                r = $.grep(unitcodes, function (g) { return g.bit === c; });
            /*
               always 0
               always 0
               always 0
               bit 1 of unit number
               bit 0 of unit number
               1 for OFF command.
               bit 2 of unit number
               1 DIM / BRIGHT command
            */
            return r.length ? r[0].code : '-';
        }
        function onFromCode(byte) {
            return byte.substring(5, 6) === '0';
        }
        function setInputs(house, unit, action) {
            $('#housecode').val(house + '');
            $('#unitcode').val(unit + '');
            $('#action').val(action + '');
        }
        function signalFromHouse(house, unit) {
            var a = [],// byte 1 normal
                f = [],// byte 2 flipped (checksum)
                r = $.grep(housecodes, function (g) { return g.code === house; });
            typeof unit === 'string' && (unit = parseInt(unit, 10));
            if (r.length) {
                r = r[0].bit.split('').reverse();
                console.log(r);
                $.each(r, function (i, o) {
                    a.push(o === '1' ? sendOne : sendZero);
                    f.push(o === '0' ? sendOne : sendZero);
                });
                // empty byte
                a.push(sendZero);
                f.push(sendOne);
                if (unit > 8) {
                    // empty byte
                    a.push(sendOne);
                    f.push(sendZero);
                }
                else {
                    // empty byte
                    a.push(sendZero);
                    f.push(sendOne);
                }
                // empty byte
                a.push(sendZero);
                f.push(sendOne);
                // empty byte
                a.push(sendZero);
                f.push(sendOne);
                console.log(a, f);
                return a.join('') + f.join('');
            }
        }
        function signalFromUnit(unit, on) {
            var a = [],// byte3 normal
                f = [],// byte4 flipped (checksum)
                b;
            typeof unit !== 'number' && (unit = parseInt(unit, 10));
            if (!unit) { return ''; }
            // 0: One for BRIGHT or DIM
            a.push(sendZero);
            f.push(sendOne);
            // 1: One for unit codes 5-8 & 13-16
            b = [5, 6, 7, 8, 13, 14, 15, 16].indexOf(unit) !== -1;
            a.push(b ? sendOne : sendZero);
            f.push(b ? sendZero : sendOne);
            // 2: One for OFF, Zero for ON
            b = typeof on === 'string'
                ? (on === 'true' ? true : false)
                : (typeof on === 'boolean' ? on : false);
            a.push(b ? sendZero : sendOne);
            f.push(b ? sendOne : sendZero);
            // 3: One for unit codes 2,4,6,8,10,12,14,16
            b = [2, 4, 6, 8, 10, 12, 14, 16].indexOf(unit) !== -1;
            a.push(b ? sendOne : sendZero);
            f.push(b ? sendZero : sendOne);
            // 4: One for unit codes 3,4,7,8,11,12,15,16
            b = [3, 4, 7, 8, 11, 12, 15, 16].indexOf(unit) !== -1;
            a.push(b ? sendOne : sendZero);
            f.push(b ? sendZero : sendOne);
            // 5: empty byte
            a.push(sendZero);
            f.push(sendOne);
            // 6: empty byte
            a.push(sendZero);
            f.push(sendOne);
            // 7: empty byte
            a.push(sendZero);
            f.push(sendOne);
            console.log(a, f);
            return a.join('') + f.join('');
        }
        function generateData() {
            var h = $('#housecode').val(),
                u = $('#unitcode').val(),
                s = '';
            $('#generated-data').val('');
            if (!h || !u) { openModal('*** Choose both house and unit code ***'); return; }
            h = signalFromHouse(h, u);
            u = signalFromUnit(u, $('#action').val());
            if (h && u) {
                // opening
                s = 'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000';
                // house
                s += h;
                // unit
                s += u;
                // ending
                s += sendOne;
                s += '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000';
                $('#generated-data').val(s);
            }
            else { console.log(h, u); openModal('*** An error occurred ***'); }
        }
        jQuery(document).ready(function ($) {
            $('#parse').on('click', function () {
                var d = $('#raw-data').val() || '',
                    a, i, p = [], e;
                if (!d) { openModal('*** Enter the scan data ***'); return; }
                // replace noise
                d = d.replace(/[^F0]/gi, 'F').replace(/F0F/gi, 'FFF');
                // now find first after pause
                i = d.indexOf('FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF');
                if (i > 0) {
                    d = d.substring(i);
                }
                // find starts
                a = d.split('FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF');
                $.each(a, function (i, o) {
                    var r = [], s;
                    if (o.length > 10) {
                        o = o.replace(/0F/gi, 'O#F').split('#');
                        if (o.length === 34) {
                            s = '';
                            // skip first element
                            $.each(o.slice(1, 9), function (k, v) {
                                s += getbit(v);
                            });
                            r.push(s);
                            s = '';
                            $.each(o.slice(9, 17), function (k, v) {
                                s += getbit(v);
                            });
                            r.push(s);
                            s = '';
                            $.each(o.slice(17, 25), function (k, v) {
                                s += getbit(v);
                            });
                            r.push(s);
                            s = '';
                            $.each(o.slice(25, 33), function (k, v) {
                                s += getbit(v);
                            });
                            r.push(s);
                        }
                    }
                    if (r.length === 4) {
                        if (checksum(r[0], r[1]) && checksum(r[2], r[3])) {
                            p.push([reverseBits(r[0]), reverseBits(r[2])]);
                        }
                        else { !e && (e = 'Checksum failed.'); }
                    }
                    else if (r.length) { !e && (e = 'Invalid byte count.'); }

                });
                if (p.length) {
                    a = '';
                    d = true;
                    // if signal repeated, are they all equal?
                    $.each(p, function (i, o) {
                        var r = o.join('');
                        if (!a) { a = r; }
                        else if (a !== r) {
                            d = false;
                        }
                    });
                    p = d ? p[0] : [];
                }
                else { !e && (e = 'Repeated signals different.'); }
                if (p.length) {
                    setInputs(houseFromCode(p[0]), unitFromCode(p), onFromCode(p[1]));
                    openModal('Success!');
                    $('#raw-data').val('');
                    generateData();
                }
                else {
                    openModal(e ? e : '*** An error occurred ***');
                    $('#housecode').val('');
                    $('#unitcode').val('');
                }
            });
            $('#generate').on('click', generateData);
        });
    </script>
    <script id="modal" type="text/html">
        <div class="modal-context" role="dialog">
             <div class="modal-container" role="region" tabindex="0">
                 <button class="modal-close" type="button">
                     <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M0.96875 15.5306L15.0313 1.46812" stroke="#A9B4BC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M15.0313 15.5306L0.96875 1.46812" stroke="#A9B4BC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                     </svg>
                 </button>
                <div class="modal-content"></div>   
            </div>
        </div>
    </script>
</body>
</html>
